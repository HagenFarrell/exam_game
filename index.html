<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Exam Arcade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Animations */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .float-up { animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        .streak-fire { text-shadow: 0 0 10px #f59e0b, 0 0 20px #ef4444; }
        
        /* Confetti Canvas */
        #confetti-canvas { pointer-events: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
        
        /* Shop Button Styles */
        .powerup-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .powerup-btn:not(:disabled):hover { transform: translateY(-2px); }
        .powerup-btn:not(:disabled):active { transform: translateY(1px); }

        /* Slider Styles */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex items-center justify-center p-4 relative overflow-hidden">

    <canvas id="confetti-canvas"></canvas>

    <div id="game-container" class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden border border-slate-700 relative min-h-[750px] flex flex-col z-10 transition-transform duration-100">
        
        <div class="bg-slate-900/90 backdrop-blur p-3 border-b border-slate-700 grid grid-cols-3 items-center sticky top-0 z-40">
            
            <div class="flex flex-col gap-1">
                <div class="flex gap-1 text-rose-500 text-lg" id="lives-display">
                    <i class="fas fa-heart"></i><i class="fas fa-heart"></i><i class="fas fa-heart"></i>
                </div>
                <div class="flex items-center gap-2 text-yellow-400 font-bold text-sm">
                    <i class="fas fa-coins"></i> <span id="coins-display">0</span>
                </div>
            </div>

            <div class="text-center">
                <div class="text-slate-500 text-[10px] font-bold tracking-widest uppercase">Score</div>
                <div id="score-display" class="text-2xl font-black text-white font-mono leading-none">0</div>
                <div id="multiplier-badge" class="hidden text-[10px] font-black text-amber-500 tracking-widest uppercase animate-pulse mt-1">
                    Combo x<span id="mult-val">1</span>
                </div>
            </div>

            <div class="flex flex-col items-end">
                <div class="flex items-center gap-2 text-2xl font-black font-mono relative">
                    <span id="timer-text" class="text-emerald-400">20</span> 
                    <i class="fas fa-stopwatch text-slate-600"></i>
                    <i id="freeze-icon" class="fas fa-snowflake absolute -right-6 text-cyan-400 hidden animate-pulse"></i>
                </div>
                <div class="text-slate-500 text-[10px] font-bold">Q <span id="q-current">1</span>/<span id="q-total">30</span></div>
            </div>
        </div>

        <div class="w-full bg-slate-700 h-1.5">
            <div id="timer-bar" class="bg-emerald-500 h-full w-full shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
        </div>

        <div id="start-screen" class="absolute inset-0 bg-slate-800 z-30 flex flex-col items-center justify-center p-8 text-center">
            <div class="mb-4 relative">
                <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full"></div>
                <i class="fas fa-gamepad text-8xl text-indigo-500/20 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-150"></i>
                <i class="fas fa-brain text-7xl text-indigo-400 relative z-10 drop-shadow-lg"></i>
            </div>
            <h1 class="text-5xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 uppercase tracking-tight italic">Final Exam<br>Arcade</h1>
            
            <div class="bg-slate-900/50 px-4 py-2 rounded-full border border-slate-700 mb-6 flex items-center gap-2 justify-center inline-flex">
                <div id="bank-status-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                <p id="bank-status-text" class="text-slate-400 font-mono font-bold text-xs tracking-wide">Connecting...</p>
            </div>

            <div class="bg-slate-900/80 p-5 rounded-2xl border border-slate-700 mb-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <label for="time-slider" class="text-indigo-400 text-xs font-black uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-stopwatch"></i> Timer Duration
                    </label>
                    <span id="time-display" class="text-2xl font-mono font-black text-white">20s</span>
                </div>
                <input id="time-slider" type="range" min="5" max="60" step="5" value="20" 
                       class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                       oninput="document.getElementById('time-display').innerText = this.value + 's'">
                <div class="flex justify-between text-[10px] text-slate-500 font-bold uppercase mt-2">
                    <span>Panic (5s)</span>
                    <span>Standard (20s)</span>
                    <span>Relaxed (60s)</span>
                </div>
            </div>
            
            <div class="bg-slate-900/80 p-3 rounded-xl border border-slate-700 mb-6 w-full max-w-xs">
                <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1">Current High Score</div>
                <div id="high-score-display" class="text-xl font-mono font-black text-yellow-400">0</div>
            </div>

            <button id="start-btn" onclick="game.start()" disabled class="group relative bg-slate-700 text-slate-400 cursor-not-allowed px-12 py-4 rounded-2xl font-black text-xl transition-all w-full max-w-xs border border-slate-600">
                LOADING...
            </button>
        </div>

        <div id="game-over-screen" class="hidden absolute inset-0 bg-slate-800 z-30 flex flex-col items-center justify-center p-8 text-center pop-in">
            <div id="go-icon" class="text-8xl mb-6 drop-shadow-2xl"></div>
            <h2 id="go-title" class="text-5xl font-black mb-2 text-white uppercase italic tracking-tighter"></h2>
            <p id="go-msg" class="text-slate-400 mb-8 font-medium text-lg"></p>
            
            <div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 mb-8 w-full max-w-xs relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-50"></div>
                <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">Final Score</div>
                <div id="final-score" class="text-4xl font-mono font-black text-amber-400">0</div>
            </div>
            
            <button onclick="game.start()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition transform hover:scale-105 shadow-lg w-full max-w-xs">
                PLAY AGAIN
            </button>
        </div>

        <div id="quiz-content" class="flex-1 p-4 md:p-6 flex flex-col relative hidden">
            <div id="floating-feedback" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20 w-full h-full"></div>

            <div class="flex justify-between items-start mb-2">
                <span id="topic-badge" class="bg-slate-700 text-slate-300 text-[10px] font-black px-2 py-1 rounded uppercase tracking-wider border border-slate-600">
                    Topic
                </span>
            </div>

            <h2 id="question-text" class="text-lg md:text-xl font-bold mb-4 leading-snug text-white drop-shadow-sm min-h-[60px]">
                Loading...
            </h2>

            <div id="options-container" class="grid gap-3 mb-4 flex-1 overflow-y-auto content-start"></div>

            <div class="mt-auto pt-4 border-t border-slate-700">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] uppercase font-bold text-slate-500 tracking-widest">Power-Up Store</span>
                    <span class="text-[10px] font-bold text-yellow-500"><i class="fas fa-coins"></i> <span id="shop-coins">0</span></span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button id="btn-freeze" onclick="game.usePowerup('freeze')" class="powerup-btn bg-slate-900 border border-slate-700 rounded-lg p-2 flex flex-col items-center gap-1 hover:border-cyan-500 hover:bg-slate-800 transition-all group">
                        <div class="w-8 h-8 rounded-full bg-cyan-500/10 text-cyan-400 flex items-center justify-center text-sm group-hover:scale-110 transition-transform"><i class="fas fa-snowflake"></i></div>
                        <div class="text-[10px] font-bold text-slate-300">Freeze</div>
                        <div class="text-[10px] font-mono text-yellow-500">30 <i class="fas fa-coins text-[8px]"></i></div>
                    </button>
                    <button id="btn-5050" onclick="game.usePowerup('5050')" class="powerup-btn bg-slate-900 border border-slate-700 rounded-lg p-2 flex flex-col items-center gap-1 hover:border-fuchsia-500 hover:bg-slate-800 transition-all group">
                        <div class="w-8 h-8 rounded-full bg-fuchsia-500/10 text-fuchsia-400 flex items-center justify-center text-sm group-hover:scale-110 transition-transform"><i class="fas fa-cut"></i></div>
                        <div class="text-[10px] font-bold text-slate-300">50/50</div>
                        <div class="text-[10px] font-mono text-yellow-500">50 <i class="fas fa-coins text-[8px]"></i></div>
                    </button>
                    <button id="btn-heal" onclick="game.usePowerup('heal')" class="powerup-btn bg-slate-900 border border-slate-700 rounded-lg p-2 flex flex-col items-center gap-1 hover:border-rose-500 hover:bg-slate-800 transition-all group">
                        <div class="w-8 h-8 rounded-full bg-rose-500/10 text-rose-400 flex items-center justify-center text-sm group-hover:scale-110 transition-transform"><i class="fas fa-heart"></i></div>
                        <div class="text-[10px] font-bold text-slate-300">+1 Life</div>
                        <div class="text-[10px] font-mono text-yellow-500">75 <i class="fas fa-coins text-[8px]"></i></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="feedback-panel" class="hidden absolute bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md border-t border-indigo-500/30 p-6 rounded-t-3xl shadow-[0_-20px_60px_rgba(0,0,0,0.7)] pop-in z-20 max-h-[85%] overflow-y-auto">
            <div class="flex items-center gap-4 mb-4">
                <div id="fb-icon-bg" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-lg">
                    <i id="fb-icon" class="fas"></i>
                </div>
                <div>
                    <h3 id="fb-title" class="font-black text-xl uppercase italic tracking-wide">Correct!</h3>
                    <p id="fb-subtitle" class="text-slate-400 text-sm font-medium">+500 Points</p>
                </div>
            </div>

            <div class="bg-indigo-900/20 rounded-xl p-5 border border-indigo-500/20 mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                <div class="flex items-center gap-2 mb-2 text-indigo-400 text-xs font-black uppercase tracking-widest">
                    <i class="fas fa-brain"></i> Deep Dive
                </div>
                <p id="fb-rationale" class="text-slate-200 text-sm leading-relaxed"></p>
            </div>

            <button id="next-btn" onclick="game.nextQuestion()" class="w-full bg-white hover:bg-indigo-50 text-slate-900 font-bold py-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2 text-lg">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>

    </div>

    <script>
        // --- Confetti Engine ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const ctx = confettiCanvas.getContext('2d');
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
        let particles = [];

        function createConfetti() {
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height - confettiCanvas.height,
                    vx: Math.random() * 4 - 2,
                    vy: Math.random() * 5 + 2,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    size: Math.random() * 8 + 2
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            if (particles.length === 0) return;
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                if (p.y > confettiCanvas.height) particles.splice(i, 1);
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            });
            requestAnimationFrame(animateConfetti);
        }
        // -----------------------

        // --- Game Logic ---
        const game = {
            state: {
                currentQ: 0,
                lives: 3,
                score: 0,
                timer: 20,
                timeLimit: 20, // Default Time Limit
                streak: 0,
                coins: 0,
                interval: null,
                frozen: false,
                allQuestions: [], 
                activeQuestions: []
            },

            async loadQuestions() {
                const statusText = document.getElementById('bank-status-text');
                const statusDot = document.getElementById('bank-status-dot');
                const startBtn = document.getElementById('start-btn');

                try {
                    const response = await fetch('./questions.json');
                    if (!response.ok) throw new Error("Failed to load questions");
                    this.state.allQuestions = await response.json();
                    
                    // UPDATE UI WITH BANK COUNT
                    const count = this.state.allQuestions.length;
                    statusText.innerText = `${count} Questions Ready in Bank`;
                    statusText.className = "text-emerald-400 font-mono font-bold text-xs tracking-wide";
                    statusDot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.8)]";
                    
                    // Enable Start Button
                    startBtn.disabled = false;
                    startBtn.innerText = "START GAME";
                    startBtn.className = "group relative bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white px-12 py-4 rounded-2xl font-black text-xl transition-all hover:-translate-y-1 shadow-[0_10px_20px_rgba(79,70,229,0.3)] active:translate-y-1 active:shadow-none w-full max-w-xs";

                    console.log(`Loaded ${count} questions.`);
                } catch (error) {
                    statusText.innerText = "Error: Use Local Server!";
                    statusText.className = "text-rose-500 font-mono font-bold text-xs tracking-wide";
                    statusDot.className = "w-2 h-2 rounded-full bg-rose-500 animate-pulse";
                    console.error(error);
                }
            },

            loadHighScore() {
                const stored = localStorage.getItem('finalExamHighScore');
                if (stored) {
                    document.getElementById('high-score-display').innerText = parseInt(stored).toLocaleString();
                }
            },

            saveHighScore() {
                const currentHigh = parseInt(localStorage.getItem('finalExamHighScore') || '0');
                if (this.state.score > currentHigh) {
                    localStorage.setItem('finalExamHighScore', this.state.score);
                    document.getElementById('high-score-display').innerText = this.state.score.toLocaleString();
                }
            },

            async start() {
                if (this.state.allQuestions.length === 0) {
                    await this.loadQuestions();
                }

                if (this.state.allQuestions.length === 0) return; 

                // READ TIME LIMIT FROM SLIDER
                const sliderVal = document.getElementById('time-slider').value;
                this.state.timeLimit = parseInt(sliderVal);

                // --- PRIORITY QUEUE LOGIC ---
                // 1. Separate "Must Know" Priority questions from the rest
                const priorityQs = this.state.allQuestions.filter(q => q.topic.includes("Exam Priority"));
                const fillerQs = this.state.allQuestions.filter(q => !q.topic.includes("Exam Priority"));

                // 2. Determine how many fillers we need to reach 30
                const GAME_LENGTH = 30;
                const priorityCount = Math.min(priorityQs.length, GAME_LENGTH); 
                const fillerCount = Math.max(0, GAME_LENGTH - priorityCount);

                // 3. Shuffle fillers and take the needed amount
                fillerQs.sort(() => 0.5 - Math.random());
                const selectedFillers = fillerQs.slice(0, fillerCount);

                // 4. Combine priority + selected fillers into one deck
                const finalDeck = [...priorityQs, ...selectedFillers];

                // 5. Shuffle the final deck so priorities aren't all at the start
                finalDeck.sort(() => 0.5 - Math.random());

                this.state.activeQuestions = finalDeck;
                // -----------------------------

                this.state.currentQ = 0;
                this.state.lives = 3;
                this.state.score = 0;
                this.state.timer = this.state.timeLimit;
                this.state.streak = 0;
                this.state.coins = 0;
                this.state.frozen = false;
                
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('game-over-screen').classList.add('hidden');
                document.getElementById('quiz-content').classList.remove('hidden');
                document.getElementById('confetti-canvas').style.display = 'none';
                document.getElementById('q-total').innerText = this.state.activeQuestions.length;
                
                this.updateStreakUI();
                this.updateShopUI();
                this.loadQuestion();
            },

            loadQuestion() {
                if (this.state.currentQ >= this.state.activeQuestions.length) {
                    this.endGame(true);
                    return;
                }

                document.getElementById('feedback-panel').classList.add('hidden');
                const bar = document.getElementById('timer-bar');
                bar.className = "h-full w-full shadow-[0_0_10px_rgba(16,185,129,0.5)] bg-emerald-500 transition-none";
                bar.style.width = '100%';
                
                const q = this.state.activeQuestions[this.state.currentQ];
                document.getElementById('topic-badge').innerText = q.topic;
                document.getElementById('question-text').innerHTML = q.text;
                document.getElementById('q-current').innerText = this.state.currentQ + 1;
                
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                this.state.frozen = false;
                document.getElementById('freeze-icon').classList.add('hidden');
                
                // Shuffle Answers
                let indices = q.options.map((_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }

                indices.forEach((originalIndex) => {
                    const opt = q.options[originalIndex];
                    const btn = document.createElement('button');
                    btn.innerHTML = opt;
                    btn.id = `opt-${originalIndex}`;
                    btn.className = "group relative w-full text-left p-4 rounded-2xl bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 transition-all font-bold text-slate-200 active:scale-[0.98] hover:shadow-lg hover:border-slate-500 text-sm md:text-base";
                    btn.onclick = () => this.handleAnswer(originalIndex, btn);
                    container.appendChild(btn);
                });

                this.renderLives();
                this.updateShopUI();
                if (window.MathJax) MathJax.typesetPromise();
                this.startTimer();
            },

            startTimer() {
                clearInterval(this.state.interval);
                this.state.timer = this.state.timeLimit; // Use the dynamic limit
                this.updateTimerUI();
                const bar = document.getElementById('timer-bar');
                void bar.offsetWidth; 
                bar.style.transition = 'width 1s linear, background-color 1s linear';
                
                this.state.interval = setInterval(() => {
                    if (this.state.frozen) return; 
                    this.state.timer--;
                    this.updateTimerUI();
                    if (this.state.timer <= 0) this.timeOut();
                }, 1000);
            },

            updateTimerUI() {
                const txt = document.getElementById('timer-text');
                const bar = document.getElementById('timer-bar');
                txt.innerText = this.state.timer;
                
                // Calculate percentage based on the selected time limit
                const pct = (this.state.timer / this.state.timeLimit) * 100;
                bar.style.width = pct + '%';
                
                if (this.state.frozen) {
                    bar.className = "h-full bg-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.8)]";
                    txt.className = "text-cyan-400";
                    return;
                }
                
                // Warn at 25% remaining time instead of fixed 5s
                if (this.state.timer <= (this.state.timeLimit * 0.25)) {
                    txt.className = "text-rose-500 animate-pulse";
                    bar.className = "h-full bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.8)]";
                } else if (this.state.timer <= (this.state.timeLimit * 0.5)) {
                    txt.className = "text-amber-400";
                    bar.className = "h-full bg-amber-400";
                } else {
                    txt.className = "text-emerald-400";
                    bar.className = "h-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
                }
            },

            handleAnswer(originalIndex, btnEl) {
                if (!document.getElementById('feedback-panel').classList.contains('hidden')) return;
                clearInterval(this.state.interval);
                
                const q = this.state.activeQuestions[this.state.currentQ];
                const isCorrect = (originalIndex === q.correct);
                const allBtns = document.getElementById('options-container').children;

                Array.from(allBtns).forEach(b => b.disabled = true);
                document.getElementById(`opt-${q.correct}`).className = "w-full text-left p-4 rounded-2xl bg-emerald-600 border-2 border-emerald-400 text-white shadow-[0_0_20px_rgba(16,185,129,0.4)] font-bold text-sm md:text-base";

                if (isCorrect) {
                    this.state.streak++;
                    const multiplier = Math.min(this.state.streak, 4);
                    // Adjust points based on time limit difficulty (Optional but nice)
                    const difficultyMod = 20 / this.state.timeLimit; 
                    const points = Math.round((1000 + (this.state.timer * 50)) * multiplier * difficultyMod);
                    const earnedCoins = 10 + (multiplier * 5);
                    this.state.coins += earnedCoins;
                    
                    this.animateScore(points);
                    this.showFloatText(btnEl, `+${points}`, "text-emerald-400");
                    this.showFloatText(document.getElementById('coins-display'), `+${earnedCoins}`, "text-yellow-400", -20);
                    if (this.state.streak > 1) this.showFloatText(btnEl, `COMBO x${multiplier}!`, "text-amber-400 streak-fire text-2xl", 50);
                } else {
                    btnEl.className = "w-full text-left p-4 rounded-2xl bg-rose-600 border-2 border-rose-500 text-white font-bold text-sm md:text-base";
                    document.getElementById('game-container').classList.add('shake');
                    setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 500);
                    this.state.lives--;
                    this.state.streak = 0;
                    this.showFloatText(btnEl, "MISS", "text-rose-500");
                }
                this.updateStreakUI();
                this.updateShopUI();
                this.renderLives();
                this.showFeedback(isCorrect);
            },

            usePowerup(type) {
                if (document.getElementById('feedback-panel').classList.contains('hidden') === false) return;

                if (type === 'freeze') {
                    if (this.state.coins >= 30 && !this.state.frozen) {
                        this.state.coins -= 30;
                        this.state.frozen = true;
                        document.getElementById('freeze-icon').classList.remove('hidden');
                        this.updateTimerUI();
                        this.updateShopUI();
                    }
                } else if (type === '5050') {
                    if (this.state.coins >= 50) {
                        const q = this.state.activeQuestions[this.state.currentQ];
                        let wrongIndices = [0, 1, 2, 3].filter(i => i !== q.correct);
                        wrongIndices.sort(() => Math.random() - 0.5);
                        const btnToCheck = document.getElementById(`opt-${wrongIndices[0]}`);
                        if (btnToCheck && btnToCheck.style.visibility === 'hidden') return;

                        this.state.coins -= 50;
                        if(wrongIndices.length >= 2) {
                                document.getElementById(`opt-${wrongIndices[0]}`).style.visibility = 'hidden';
                                document.getElementById(`opt-${wrongIndices[1]}`).style.visibility = 'hidden';
                        }
                        this.updateShopUI();
                    }
                } else if (type === 'heal') {
                    if (this.state.coins >= 75 && this.state.lives < 3) {
                        this.state.coins -= 75;
                        this.state.lives++;
                        this.renderLives();
                        this.updateShopUI();
                    }
                }
            },

            updateShopUI() {
                document.getElementById('coins-display').innerText = this.state.coins;
                document.getElementById('shop-coins').innerText = this.state.coins;
                document.getElementById('btn-freeze').disabled = (this.state.coins < 30 || this.state.frozen);
                document.getElementById('btn-5050').disabled = (this.state.coins < 50);
                document.getElementById('btn-heal').disabled = (this.state.coins < 75 || this.state.lives >= 3);
            },

            showFloatText(element, text, classes, offsetY = 0) {
                const rect = element.getBoundingClientRect();
                const container = document.getElementById('game-container').getBoundingClientRect();
                const el = document.createElement('div');
                el.className = `absolute font-black pointer-events-none float-up z-30 ${classes}`;
                el.style.left = (rect.left - container.left + rect.width/2) + 'px';
                el.style.top = (rect.top - container.top - offsetY) + 'px';
                el.style.transform = 'translate(-50%, -50%)';
                el.innerText = text;
                document.getElementById('quiz-content').appendChild(el);
                setTimeout(() => el.remove(), 1000);
            },

            animateScore(added) {
                const start = this.state.score;
                this.state.score += added;
                const end = this.state.score;
                const duration = 1000;
                const startTime = performance.now();
                const el = document.getElementById('score-display');
                const step = (now) => {
                    const progress = Math.min((now - startTime) / duration, 1);
                    const current = Math.floor(start + (end - start) * progress);
                    el.innerText = current.toLocaleString();
                    if (progress < 1) requestAnimationFrame(step);
                };
                requestAnimationFrame(step);
            },

            updateStreakUI() {
                const badge = document.getElementById('multiplier-badge');
                if (this.state.streak > 1) {
                    badge.classList.remove('hidden');
                    const mult = Math.min(this.state.streak, 4);
                    document.getElementById('mult-val').innerText = mult;
                } else {
                    badge.classList.add('hidden');
                }
            },

            showFeedback(isCorrect) {
                const q = this.state.activeQuestions[this.state.currentQ];
                const panel = document.getElementById('feedback-panel');
                const title = document.getElementById('fb-title');
                const sub = document.getElementById('fb-subtitle');
                const iconBg = document.getElementById('fb-icon-bg');
                const icon = document.getElementById('fb-icon');

                panel.classList.remove('hidden');
                document.getElementById('fb-rationale').innerHTML = q.rationale;
                
                if (window.MathJax) MathJax.typesetPromise();

                if (isCorrect) {
                    title.innerText = "EXCELLENT!";
                    title.className = "font-black text-2xl uppercase italic tracking-wide text-white";
                    sub.innerText = "Streak: " + this.state.streak + " ðŸ”¥";
                    icon.className = "fas fa-check";
                    iconBg.className = "w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-lg bg-emerald-500 text-white";
                } else {
                    title.innerText = "WRONG";
                    title.className = "font-black text-2xl uppercase italic tracking-wide text-rose-500";
                    sub.innerText = "Correct answer highlighted.";
                    icon.className = "fas fa-times";
                    iconBg.className = "w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-lg bg-rose-500 text-white";
                }

                if (this.state.lives <= 0) {
                    document.getElementById('next-btn').innerHTML = 'FINISH GAME <i class="fas fa-flag-checkered ml-2"></i>';
                } else {
                    document.getElementById('next-btn').innerHTML = 'NEXT <i class="fas fa-chevron-right ml-2"></i>';
                }
            },

            timeOut() {
                clearInterval(this.state.interval);
                this.state.lives--;
                this.state.streak = 0;
                this.updateStreakUI();
                this.renderLives();
                document.getElementById('game-container').classList.add('shake');
                setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 500);
                
                const q = this.state.activeQuestions[this.state.currentQ];
                const panel = document.getElementById('feedback-panel');
                panel.classList.remove('hidden');
                document.getElementById('fb-rationale').innerHTML = q.rationale;
                
                if (window.MathJax) MathJax.typesetPromise();
                
                document.getElementById('fb-title').innerText = "TIME UP!";
                document.getElementById('fb-title').className = "font-black text-2xl uppercase italic tracking-wide text-amber-500";
                document.getElementById('fb-subtitle').innerText = "Too slow!";
                document.getElementById('fb-icon').className = "fas fa-hourglass-end";
                document.getElementById('fb-icon-bg').className = "w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-lg bg-amber-500 text-white";
                
                if (this.state.lives <= 0) {
                    document.getElementById('next-btn').innerHTML = 'FINISH GAME <i class="fas fa-flag-checkered ml-2"></i>';
                } else {
                    document.getElementById('next-btn').innerHTML = 'NEXT <i class="fas fa-chevron-right ml-2"></i>';
                }
            },

            nextQuestion() {
                if (this.state.lives <= 0) {
                    this.endGame(false);
                } else {
                    this.state.currentQ++;
                    this.loadQuestion();
                }
            },

            renderLives() {
                const container = document.getElementById('lives-display');
                container.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    container.innerHTML += (i < this.state.lives) 
                        ? '<i class="fas fa-heart drop-shadow-md"></i>' 
                        : '<i class="fas fa-heart-broken text-slate-700 opacity-50"></i>';
                }
            },

            endGame(victory) {
                const screen = document.getElementById('game-over-screen');
                screen.classList.remove('hidden');
                document.getElementById('quiz-content').classList.add('hidden');
                document.getElementById('feedback-panel').classList.add('hidden');

                const icon = document.getElementById('go-icon');
                const title = document.getElementById('go-title');
                const msg = document.getElementById('go-msg');

                document.getElementById('final-score').innerText = this.state.score.toLocaleString();
                this.saveHighScore();

                if (victory) {
                    icon.innerHTML = '<i class="fas fa-trophy text-amber-400 drop-shadow-[0_0_15px_rgba(251,191,36,0.5)]"></i>';
                    title.innerText = "VICTORY!";
                    title.className = "text-5xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-br from-amber-300 to-orange-500 uppercase italic";
                    msg.innerText = "You conquered the exam pool!";
                    document.getElementById('confetti-canvas').style.display = 'block';
                    createConfetti();
                } else {
                    icon.innerHTML = '<i class="fas fa-skull text-slate-600"></i>';
                    title.innerText = "GAME OVER";
                    title.className = "text-5xl font-black mb-2 text-slate-500 uppercase italic";
                    msg.innerText = "Better luck next time.";
                }
            }
        };

        game.init = function() {
            this.loadHighScore();
            this.renderLives();
            this.loadQuestions(); // Pre-load questions
        };
        game.init();

    </script>
</body>
</html>